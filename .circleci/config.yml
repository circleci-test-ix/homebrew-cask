version: 2.1

orbs:
  compare-url: iynere/compare-url@1.2.0

jobs:
  build:
    macos:
      xcode: "10.0"
    steps:
      - checkout
#       - restore_cache:
#           key: dependency-bundle
#       - restore_cache:
#           key: dependency-portable-ruby
      - run:
          name: force strict error checking
          command: |
            # Force strict error checking.
            set -o errexit
            set -o pipefail
      - compare-url/reconstruct
      - compare-url/use:
          step-name: Update Travis commit range.
          attach-workspace: true
          custom-logic: |            
            BRANCH_COMMIT="${COMMIT_RANGE##*.}"
            TARGET_COMMIT="${COMMIT_RANGE%%.*}"
            if ! MERGE_BASE="$(git merge-base "${BRANCH_COMMIT}" "${TARGET_COMMIT}" 2>/dev/null)"; then
              git fetch --unshallow
              MERGE_BASE="$(git merge-base "${BRANCH_COMMIT}" "${TARGET_COMMIT}")"
            fi
            TRAVIS_COMMIT_RANGE_1="${MERGE_BASE}...${BRANCH_COMMIT}"
            echo $TRAVIS_COMMIT_RANGE_1
            echo 'export TRAVIS_COMMIT_RANGE="${MERGE_BASE}...${BRANCH_COMMIT}"' >> $BASH_ENV
      - run:
          name: "What is my commit range environment variable"
          command: echo $COMMIT_RANGE
      - run:
          name: "What is my TRAVIS commit range environment variable"
          command: echo $TRAVIS_COMMIT_RANGE
#       - run:
#           name: Switch to master branch.
#           command: |
#             # Switch to master branch.
#             echo 'export HOMEBREW_COLOR=1' >> $BASH_ENV
#             echo 'export HOMEBREW_DEVELOPER=1' >> $BASH_ENV
#             echo 'export HOMEBREW_NO_AUTO_UPDATE=1' >> $BASH_ENV
#             brew update-reset
#       - run:
#           name: "Fix CIRCLE_WORKING_DIRECTORY"
#           command: echo 'CIRCLE_WORKING_DIRECTORY="${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}"' >> $BASH_ENV
#       - run:
#           name: Mirror the repo as a tap.
#           command: |
#             # Mirror the repo as a tap.    
#             echo **HELLO**
#             echo ${TRAVIS_COMMIT_RANGE}
#             echo **HELLO AGAIN**
#             TAP_DIR="$(brew --repository)/Library/Taps/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
#             mkdir -p ${TAP_DIR}            
#             rsync -az --delete "${CIRCLE_WORKING_DIRECTORY}/" "${TAP_DIR}/"
#             builtin cd "${TAP_DIR}"
#             brew cask ci
#       - save_cache:
#           key: dependency-bundle
#           paths:
#             - /usr/local/Homebrew/Library/Homebrew/vendor/bundle
#       - save_cache:
#           key: dependency-portable-ruby
#           paths:
#             - /usr/local/Homebrew/Library/Homebrew/vendor/portable-ruby
