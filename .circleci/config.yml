version: 2.1

orbs:
  compare-url: iynere/compare-url@1.2.0

jobs:
  build:
    macos:
      xcode: "10.0"
    environment:
      HOMEBREW_DEVELOPER: 1
      HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - checkout
      - restore_cache:
          key: dependency-bundle
      - restore_cache:
          key: dependency-portable-ruby
      - run:
          name: force strict error checking
          command: |
            # Force strict error checking.
            set -o errexit
            set -o pipefail
      - compare-url/reconstruct
      - compare-url/use:
          step-name: Update Travis commit range.
          custom-logic: |            
            BRANCH_COMMIT="${COMMIT_RANGE##*.}"
            TARGET_COMMIT="${COMMIT_RANGE%%.*}"
            if ! MERGE_BASE="$(git merge-base "${BRANCH_COMMIT}" "${TARGET_COMMIT}" 2>/dev/null)"; then
              git fetch --unshallow
              MERGE_BASE="$(git merge-base "${BRANCH_COMMIT}" "${TARGET_COMMIT}")"
            fi
            #echo 'export TRAVIS_COMMIT_RANGE='"$MERGE_BASE...$BRANCH_COMMIT" >> $BASH_ENV
            echo 'export TRAVIS_COMMIT_RANGE='"bc6b0ba9d3ea965c9da36c46f12672d2a78726b5...04714d5ee49d" >> $BASH_ENV            
      - run:
          name: Switch to master branch.
          command: |
            # Switch to master branch.
            # echo 'export HOMEBREW_COLOR=1' >> $BASH_ENV
            # echo 'export HOMEBREW_DEVELOPER=1' >> $BASH_ENV
            # echo 'export HOMEBREW_NO_AUTO_UPDATE=1' >> $BASH_ENV
            # source $BASH_ENV
            # brew remove $(brew list)
            # rm -rf /usr/local/Homebrew/Library/Taps/
            # export HOMEBREW_COLOR=1
            # export HOMEBREW_DEVELOPER=1
            # export HOMEBREW_NO_AUTO_UPDATE=1    
            brew --version
            brew update-reset
            brew --env
            brew config
            # brew update-reset
      - run:
          name: "Fix CIRCLE_WORKING_DIRECTORY"
          command: echo 'CIRCLE_WORKING_DIRECTORY="${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}"' >> $BASH_ENV
      - run:
          name: Mirror the repo as a tap.
          command: |
            # Mirror the repo as a tap.    
            echo "${TRAVIS_COMMIT_RANGE}"
            echo "${CIRCLE_WORKING_DIRECTORY}"
            TAP_DIR="$(brew --repository)/Library/Taps/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}"
            echo "${TAP_DIR}"
            mkdir -p ${TAP_DIR}            
            rsync -az --delete "${CIRCLE_WORKING_DIRECTORY}/" "${TAP_DIR}/"
            #echo 'export CIRCLE_WORKING_DIRECTORY='"$TAP_DIR" >> $BASH_ENV
            export CIRCLE_WORKING_DIRECTORY="${TAP_DIR}"
            builtin cd "${CIRCLE_WORKING_DIRECTORY}"
            #builtin cd "${TAP_DIR}"
            brew cask ci
      - save_cache:
          key: dependency-bundle
          paths:
            - /usr/local/Homebrew/Library/Homebrew/vendor/bundle
      - save_cache:
          key: dependency-portable-ruby
          paths:
            - /usr/local/Homebrew/Library/Homebrew/vendor/portable-ruby
